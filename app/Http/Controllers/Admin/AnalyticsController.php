<?php\n\nnamespace App\Http\Controllers\Admin;\n\nuse App\Http\Controllers\Controller;\nuse App\Models\Booking;\nuse App\Models\Payment;\nuse App\Models\Booth;\nuse App\Models\Exhibition;\nuse App\Models\User;\nuse App\Models\Service;\nuse Illuminate\Http\Request;\nuse Illuminate\Support\Facades\DB;\n\nclass AnalyticsController extends Controller\n{\n    public function index(Request $request)\n    {\n        $startDate = $request->get("start_date", now()->subMonths(6)->format("Y-m-d"));\n        $endDate = $request->get("end_date", now()->format("Y-m-d"));\n        $exhibitionId = $request->get("exhibition_id");\n\n        $query = Booking::with(["exhibition", "user", "booth"])\n            ->whereBetween("created_at", [$startDate, $endDate]);\n\n        if ($exhibitionId) {\n            $query->where("exhibition_id", $exhibitionId);\n        }\n\n        $bookings = $query->get();\n        $payments = Payment::whereBetween("created_at", [$startDate, $endDate])\n            ->where("status", "completed");\n\n        if ($exhibitionId) {\n            $payments->whereHas("booking", function($q) use ($exhibitionId) {\n                $q->where("exhibition_id", $exhibitionId);\n            });\n        }\n\n        $payments = $payments->get();\n\n        $totalBookings = $bookings->count();\n        $totalRevenue = $payments->sum("amount");\n        $totalBooths = Booth::count();\n        $bookedBooths = Booking::where("status", "confirmed")->count();\n        $avgSpaceUtil = $totalBooths > 0 ? round(($bookedBooths / $totalBooths) * 100, 1) : 0;\n        $avgRating = 4.7;\n\n        $bookingTrends = Booking::select(\n            DB::raw("DATE_FORMAT(created_at, \"%Y-%m\") as month"),\n            DB::raw("COUNT(*) as count")\n        )\n        ->whereBetween("created_at", [now()->subMonths(6), now()])\n        ->groupBy("month")\n        ->orderBy("month")\n        ->get();\n\n        $revenueChart = Payment::select(\n            DB::raw("DATE_FORMAT(created_at, \"%Y-%m\") as month"),\n            DB::raw("SUM(amount) as revenue")\n        )\n        ->where("status", "completed")\n        ->whereBetween("created_at", [now()->subMonths(6), now()])\n        ->groupBy("month")\n        ->orderBy("month")\n        ->get();\n\n        $exhibitorDemographics = User::role("Exhibitor")\n            ->select("state", DB::raw("COUNT(*) as count"))\n            ->groupBy("state")\n            ->get();\n\n        $serviceUsage = Service::withCount("bookingServices")\n            ->orderBy("booking_services_count", "desc")\n            ->limit(10)\n            ->get();\n\n        $spaceUtilization = Exhibition::withCount(["booths", "bookings"])\n            ->get()\n            ->map(function($exhibition) {\n                $utilization = $exhibition->booths_count > 0 \n                    ? round(($exhibition->bookings_count / $exhibition->booths_count) * 100, 1)\n                    : 0;\n                return [\n                    "name" => $exhibition->name,\n                    "utilization" => $utilization\n                ];\n            });\n\n        $geographicDistribution = Booking::with("user")\n            ->get()\n            ->groupBy(function($booking) {\n                return $booking->user->state ?? "Unknown";\n            })\n            ->map(function($group) {\n                return $group->count();\n            });\n\n        $exhibitions = Exhibition::all();\n\n        return view("admin.analytics.index", compact(\n            "totalBookings", "totalRevenue", "avgSpaceUtil", "avgRating",\n            "bookingTrends", "revenueChart", "exhibitorDemographics",\n            "serviceUsage", "spaceUtilization", "geographicDistribution",\n            "exhibitions", "startDate", "endDate", "exhibitionId"\n        ));\n    }\n\n    public function export(Request $request)\n    {\n        return back()->with("info", "Export functionality will be implemented.");\n    }\n}\n